# Making Artiq Container
The goal is to make a container that has the Artiq 7 and can be used to make gateware without having to install the Aritq and Vivado over and over for a new PC.

We are using Docker to make that container. First we install Docker and in the container we will install the Nix and Vivado and Artiq.

## Installing Docker
First install Docker. For Ubuntu use the following command. Else use the Docker webpage or chatGPT for installation guide!

```bash
sudo apt-get update && sudo apt-get install -y ca-certificates curl gnupg && \
sudo install -m 0755 -d /etc/apt/keyrings && \
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
sudo chmod a+r /etc/apt/keyrings/docker.gpg && \
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
sudo tee /etc/apt/sources.list.d/docker.list > /dev/null && \
sudo apt-get update && \
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

Afer successful installation, we create a container with nix enviornment. 

## Creating the Container

We used the Vivado 2022.2 version with Ubuntu 20.04 LTS. You have to have the Vivado installer downloaded (I suggest the [offline standalone installer](https://www.xilinx.com/member/forms/download/xef.html?filename=Xilinx_Unified_2022.2_1014_8888.tar.gz) since it doesn't ask for log in before installation make it possible to create a container!).

Then create a folder and untar the installer, assuming that it is the Download folder and named "Xilinx_Unified_2022.2_1014_8888.tar.gz"! (This is a 96GB file and might take a long time!)
```bash
tar -xzf ~/Download/Xilinx_Unified_2022.2_1014_8888.tar.gz
```

To create a container we create a folder and create the Dockerfile and install_config.txt file.

```bash
mkdir container
cd container
touch install_config.txt
touch Dockerfile
```
The install_config.txt file will have the Vivado configurations. Open the file and paste the following in the install_config.txt file and save.

```bash
#### Vivado ML Standard Install Configuration ####
Edition=Vivado ML Standard
Product=Vivado

# ARTIQ expects this path:
Destination=/opt/Xilinx

# Keep this Modules line exactly as generated by ConfigGen
Modules=Virtex UltraScale+ HBM:1,DocNav:1,Kintex UltraScale:1,Artix UltraScale+:1,Spartan-7:1,Artix-7:1,Virtex UltraScale+:1,Vitis Model Composer(Xilinx Toolbox for MATLAB and Simulink. Includes the functionality of System Generator for DSP):1,Zynq UltraScale+ MPSoC:1,Zynq-7000:1,Virtex UltraScale+ 58G:1,Kintex-7:1,Install Devices for Kria SOMs and Starter Kits:1,Kintex UltraScale+:1

InstallOptions=

CreateProgramGroupShortcuts=1
ProgramGroupFolder=Xilinx Design Tools
CreateShortcutsForAllUsers=0
CreateDesktopShortcuts=1
CreateFileAssociation=1
EnableDiskUsageOptimization=1
```


Then paste the following in the Dockerfile and save.

```bash 
# syntax=docker/dockerfile:1.6
FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

# Base deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    tzdata curl sudo git gnupg xz-utils unzip locales ca-certificates \
    libncurses5 libtinfo5 libxi6 libxrender1 libxtst6 libxrandr2 libgtk2.0-0 \
    libcanberra-gtk-module libcanberra-gtk3-module && \
    rm -rf /var/lib/apt/lists/* && \
    locale-gen en_US.UTF-8

# Create non-root user (we'll use root only for the Vivado install step)
RUN useradd -m devuser && echo "devuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
WORKDIR /home/devuser

# Nix as devuser
USER devuser
SHELL ["/bin/bash","-c"]
RUN curl -L https://nixos.org/nix/install | sh
ENV USER=devuser
ENV NIX_PATH=/home/devuser/.nix-defexpr/channels
ENV PATH=/home/devuser/.nix-profile/bin:/home/devuser/.nix-profile/sbin:$PATH
RUN . ~/.nix-profile/etc/profile.d/nix.sh || true

# Your generated config (make sure Destination=/opt/Xilinx)
COPY --chown=devuser install_config.txt /home/devuser/install_config.txt

# === Vivado install as root into /opt/Xilinx ===
USER root
# Ensure destination exists and is writable (installer usually requires root anyway)
RUN mkdir -p /opt/Xilinx && chown root:root /opt/Xilinx

# Mount the ALREADY-EXTRACTED installer dir, copy to /tmp (writable), run xsetup
RUN --mount=type=bind,from=installer,source=.,target=/mnt/xilinx,readonly \
    set -euo pipefail; \
    mkdir -p /tmp/xilinx; \
    srcdir="$(find /mnt/xilinx -maxdepth 2 -type f -name xsetup -printf '%h\n' | head -n1)"; \
    cp -a "$srcdir" /tmp/xilinx/installer; \
    chmod +x /tmp/xilinx/installer/xsetup; \
    /tmp/xilinx/installer/xsetup \
      -a XilinxEULA,3rdPartyEULA \
      -b Install \
      -c /home/devuser/install_config.txt; \
    rm -rf /tmp/xilinx

# Put Vivado on PATH for everyone
ENV PATH="/opt/Xilinx/Vivado/2022.2/bin:${PATH}"

# Back to devuser for normal use (Nix/ARTIQ, etc.)
USER devuser
WORKDIR /home/devuser
SHELL ["/bin/bash","-c"]

CMD ["bash"]
```

To build the container run the following command, which is going to take a long time! (about 20 minutes or more!)

``` bash
sudo DOCKER_BUILDKIT=1 docker build   --build-context installer=~/Download/Xilinx_Unified_2022.2_1014_8888   -t artiq-env .
```

After sucessfully building the image, let's tag and create an image so we don't have to install Vivado again. First we need to get the image ID using the following command.

```bash
sudo docker images
```
which should output
```bash
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
artiq-env    latest    1687361ead8c   4 minutes ago   43.3GB
```

and for example **1687361ead8c** was my ID. then using that ID we tag and create the image which again is going to take a long time.

``` bash
sudo docker tag 1687361ead8c vivado-snapshot:latest
sudo docker images
```












